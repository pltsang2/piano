<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™¹è†œç²¾æº–é–å®šç´</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        
        #piano { display: flex; height: 100vh; width: 100vw; }
        
        .key { 
            flex: 1; border-right: 1px solid #222; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; box-sizing: border-box; background: #333; transition: background 0.1s;
        }
        
        .key span { font-size: 1.5rem; color: rgba(255,255,255,0.3); pointer-events: none; margin-bottom: 5px; }
        .key-note { font-size: 2.5rem !important; color: #FFF !important; text-shadow: 0 0 10px rgba(0,0,0,0.5); }

        /* å½©è™¹è‰²ç³» */
        .key:nth-child(1) { background: #4a0e0e; border-top: 5px solid #FF0000; }
        .key:nth-child(2) { background: #4a250e; border-top: 5px solid #FF7F00; }
        .key:nth-child(3) { background: #4a4a0e; border-top: 5px solid #FFFF00; }
        .key:nth-child(4) { background: #0e4a0e; border-top: 5px solid #00FF00; }
        .key:nth-child(5) { background: #0e0e4a; border-top: 5px solid #0000FF; }
        .key:nth-child(6) { background: #2e0e4a; border-top: 5px solid #4B0082; }
        .key:nth-child(7) { background: #4a0e4a; border-top: 5px solid #9400D3; }
        .key:nth-child(8) { background: #4a0e25; border-top: 5px solid #FF1493; }

        .key.active { filter: brightness(2.5); transform: scaleY(0.98); }

        /* æ¸¸æ¨™ */
        #cursor {
            position: absolute; top: 50%; left: 50%;
            width: 30px; height: 30px;
            background: #00FF00; border: 2px solid #fff; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 50;
            box-shadow: 0 0 20px #00FF00; transition: left 0.1s linear, background 0.2s;
        }
        #cursor.locked { background: #555; box-shadow: none; border-color: #888; } /* è¢«é–ä½æ™‚ */
        
        /* çœ¼ç›ç‰¹å¯«åˆ†æè¦–çª— */
        #eye-analysis {
            position: absolute; bottom: 20px; right: 20px;
            width: 300px; height: 100px; background: #000; 
            border: 2px solid #444; z-index: 100; display: flex;
        }
        #eye-canvas { width: 100%; height: 100%; }
        #eye-text {
            position: absolute; bottom: 125px; right: 20px;
            color: white; font-size: 14px; background: rgba(0,0,0,0.7); padding: 5px;
        }

        /* æ§åˆ¶é¢æ¿ */
        #panel {
            position: absolute; bottom: 20px; left: 20px; 
            background: rgba(30,30,30,0.95); color: #ddd; padding: 15px;
            border-radius: 8px; z-index: 100; width: 280px; border: 1px solid #555;
        }
        button { padding: 10px; width: 100%; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;}
        label { display: block; margin: 10px 0 5px; font-size: 0.9rem; }
        input[type=range] { width: 100%; accent-color: #007AFF; }
        
        .hint { font-size: 0.8rem; color: #888; margin-top: 2px;}
    </style>
</head>
<body>

    <div id="panel">
        <button id="startBtn" onclick="init()">ğŸ‘ï¸ å•Ÿå‹•è™¹è†œè¿½è¹¤</button>
        <div id="msg" style="color:yellow; margin-top:5px;">ç­‰å¾…å•Ÿå‹•...</div>
        <hr style="border-color:#444">
        
        <label>ğŸ‘€ çœ¼ç¥åš´æ ¼åº¦ (Eye Strictness): <span id="val-gaze">0.3</span></label>
        <input type="range" id="gazeLimit" min="0.1" max="0.5" step="0.05" value="0.3">
        <div class="hint">è¶Šå·¦é‚Šè¶Šåš´æ ¼ (å¿…é ˆæ­»ç›¯æ­£ä¸­é–“)</div>

        <label>ğŸ¹ æ¸¸æ¨™éˆæ•åº¦ (Sensitivity): <span id="val-sens">2.5</span></label>
        <input type="range" id="sensitivity" min="1" max="5" step="0.1" value="2.5">
    </div>

    <div id="eye-text">ç‹€æ…‹: æœªåµæ¸¬</div>
    <div id="eye-analysis">
        <canvas id="eye-canvas"></canvas>
    </div>

    <div id="cursor" class="locked"></div>

    <div id="piano">
        <div class="key" data-f="261.63"><span class="key-note">Do</span><span>C4</span></div>
        <div class="key" data-f="293.66"><span class="key-note">Re</span><span>D4</span></div>
        <div class="key" data-f="329.63"><span class="key-note">Mi</span><span>E4</span></div>
        <div class="key" data-f="349.23"><span class="key-note">Fa</span><span>F4</span></div>
        <div class="key" data-f="392.00"><span class="key-note">Sol</span><span>G4</span></div>
        <div class="key" data-f="440.00"><span class="key-note">La</span><span>A4</span></div>
        <div class="key" data-f="493.88"><span class="key-note">Si</span><span>B4</span></div>
        <div class="key" data-f="523.25"><span class="key-note">Do</span><span>C5</span></div>
    </div>

    <video id="hidden-video" autoplay playsinline muted style="opacity:0; position:absolute; top:0; width:1px; height:1px;"></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script>
        const video = document.getElementById('hidden-video');
        const cursor = document.getElementById('cursor');
        const eyeCanvas = document.getElementById('eye-canvas');
        const eyeCtx = eyeCanvas.getContext('2d');
        const eyeText = document.getElementById('eye-text');
        
        let audioCtx;
        let sensitivity = 2.5;
        let gazeLimit = 0.3; // è™¹è†œåé›¢ä¸­å¿ƒçš„å®¹è¨±å€¼ (0.0~0.5)
        let smoothing = 0.85;

        let currentX = window.innerWidth / 2;
        let targetX = window.innerWidth / 2;
        let isGazeValid = false; // çœ¼ç¥æ˜¯å¦åˆæ ¼

        // åƒæ•¸èª¿æ•´
        document.getElementById('sensitivity').oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            document.getElementById('val-sens').innerText = sensitivity;
        };
        document.getElementById('gazeLimit').oninput = (e) => {
            gazeLimit = parseFloat(e.target.value);
            document.getElementById('val-gaze').innerText = gazeLimit;
        };

        async function init() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('msg').innerText = "æ­£åœ¨è¼‰å…¥é«˜ç²¾åº¦æ¨¡å‹...";
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const b = audioCtx.createBuffer(1, 1, 22050);
            const s = audioCtx.createBufferSource(); s.buffer = b; s.connect(audioCtx.destination); s.start(0);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width:640, height:480 } });
                video.srcObject = stream;
                
                // è¨­å®š Canvas å¤§å°
                eyeCanvas.width = 300;
                eyeCanvas.height = 100;

                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true, // âš ï¸ é—œéµï¼šé–‹å•Ÿè™¹è†œåµæ¸¬
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onResults);

                video.onloadeddata = () => {
                    const loop = async () => { await faceMesh.send({image: video}); requestAnimationFrame(loop); };
                    loop();
                    document.getElementById('msg').innerText = "âœ… è™¹è†œè¿½è¹¤é‹ä½œä¸­";
                    document.getElementById('startBtn').style.display = 'none';
                };
            } catch (e) { alert("éŒ¯èª¤: " + e); }
        }

        function onResults(results) {
            // æ¸…é™¤ç•«å¸ƒ
            eyeCtx.fillStyle = '#000';
            eyeCtx.fillRect(0, 0, eyeCanvas.width, eyeCanvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const mesh = results.multiFaceLandmarks[0];
                
                // 1. å–å¾—è™¹è†œèˆ‡çœ¼è§’é—œéµé»
                // å·¦çœ¼: 33(å…§è§’), 133(å¤–è§’), 468(è™¹è†œä¸­å¿ƒ)
                // å³çœ¼: 362(å…§è§’), 263(å¤–è§’), 473(è™¹è†œä¸­å¿ƒ)
                
                const leftIris = mesh[468];
                const leftInner = mesh[33];
                const leftOuter = mesh[133];

                const rightIris = mesh[473];
                const rightInner = mesh[362];
                const rightOuter = mesh[263];
                
                // 2. è¨ˆç®—çœ¼ç¥åç§»é‡ (Gaze Ratio)
                // è¨ˆç®—è™¹è†œåœ¨çœ¼çœ¶æ°´å¹³æ–¹å‘çš„ä½ç½® (0=æœ€å·¦, 1=æœ€å³, 0.5=ä¸­é–“)
                
                function getRatio(iris, inner, outer) {
                    const totalDist = Math.abs(outer.x - inner.x);
                    const distToInner = Math.abs(iris.x - inner.x);
                    return distToInner / totalDist;
                }

                const ratioL = getRatio(leftIris, leftInner, leftOuter); // å·¦çœ¼æ¯”ä¾‹
                const ratioR = getRatio(rightIris, rightInner, rightOuter); // å³çœ¼æ¯”ä¾‹
                const avgRatio = (ratioL + ratioR) / 2;

                // é¡åƒä¿®æ­£ï¼šå› ç‚ºç•«é¢æ˜¯åçš„ï¼Œæ‰€ä»¥ 0.5 æ˜¯ä¸­é–“
                // æˆ‘å€‘è¨ˆç®—å®ƒé›¢ 0.5 æœ‰å¤šé 
                const deviation = Math.abs(avgRatio - 0.5);

                // 3. ç¹ªè£½çœ¼ç›åˆ†æåœ– (çµ¦è€å¸«çœ‹)
                drawEyeDebug(ratioL, ratioR, deviation);

                // 4. åˆ¤æ–·æ˜¯å¦åˆæ ¼
                // deviation è¶Šå°ä»£è¡¨è¶Šæ¥è¿‘ä¸­é–“ã€‚å¦‚æœå°æ–¼ gazeLimit å‰‡é€šé
                if (deviation < gazeLimit) {
                    isGazeValid = true;
                    eyeText.innerText = `ğŸŸ¢ çœ¼ç¥æ­£ä¸­ (åå·®: ${deviation.toFixed(2)})`;
                    eyeText.style.color = "#00FF00";
                    cursor.classList.remove('locked');
                } else {
                    isGazeValid = false;
                    eyeText.innerText = `ğŸ”´ çœ¼ç¥åç§» (åå·®: ${deviation.toFixed(2)})`;
                    eyeText.style.color = "red";
                    cursor.classList.add('locked');
                }

                // 5. è¨ˆç®—æ¸¸æ¨™ä½ç½® (ä¾ç„¶ä½¿ç”¨é¼»å°–æ§åˆ¶ä½ç½®ï¼Œæ¯”è¼ƒç›´è¦º)
                const nose = mesh[1];
                let rawX = (1 - nose.x) * window.innerWidth;
                let centerX = window.innerWidth / 2;
                let adjustedX = centerX + (rawX - centerX) * sensitivity;
                if (adjustedX < 0) adjustedX = 0;
                if (adjustedX > window.innerWidth) adjustedX = window.innerWidth;
                targetX = adjustedX;

            } else {
                isGazeValid = false;
                eyeText.innerText = "æœªåµæ¸¬åˆ°è‡‰éƒ¨";
                cursor.classList.add('locked');
            }

            // å¹³æ»‘ç§»å‹•
            currentX = currentX * smoothing + targetX * (1 - smoothing);
            cursor.style.left = currentX + 'px';

            if (isGazeValid) {
                checkCollision(currentX);
            } else {
                if (lastKey) lastKey.classList.remove('active');
                lastKey = null;
            }
        }

        // ç•«å‡ºç°¡å–®çš„çœ¼ç›ç¤ºæ„åœ–
        function drawEyeDebug(rL, rR, dev) {
            eyeCtx.strokeStyle = "#fff";
            eyeCtx.lineWidth = 2;

            // ç•«çœ¼æ¡†
            eyeCtx.strokeRect(50, 30, 80, 40); // å·¦çœ¼æ¡†
            eyeCtx.strokeRect(170, 30, 80, 40); // å³çœ¼æ¡†

            // ç•«è™¹è†œ (æ ¹æ“šæ¯”ä¾‹)
            eyeCtx.fillStyle = dev < gazeLimit ? "#00FF00" : "red";
            
            // å·¦çœ¼ç  (è¨˜å¾—é¡åƒç¿»è½‰çš„é‚è¼¯)
            // rL 0~1. åœ¨ Canvas ä¸Š 0 æ˜¯å·¦é‚Š
            eyeCtx.beginPath();
            eyeCtx.arc(50 + (rL * 80), 50, 8, 0, Math.PI * 2); 
            eyeCtx.fill();

            // å³çœ¼ç 
            eyeCtx.beginPath();
            eyeCtx.arc(170 + (rR * 80), 50, 8, 0, Math.PI * 2);
            eyeCtx.fill();
            
            // ä¸­å¿ƒè¼”åŠ©ç·š
            eyeCtx.strokeStyle = "#555";
            eyeCtx.beginPath(); eyeCtx.moveTo(90, 30); eyeCtx.lineTo(90, 70); eyeCtx.stroke();
            eyeCtx.beginPath(); eyeCtx.moveTo(210, 30); eyeCtx.lineTo(210, 70); eyeCtx.stroke();
        }

        let lastKey = null;
        let playTimer = null;

        function checkCollision(x) {
            const element = document.elementFromPoint(x, window.innerHeight / 2);
            const key = element ? element.closest('.key') : null;

            if (key !== lastKey) {
                if (lastKey) lastKey.classList.remove('active');
                if (playTimer) clearTimeout(playTimer);

                lastKey = key;

                if (key) {
                    key.classList.add('active');
                    // åœç•™ 100ms æ‰ç™¼è²
                    playTimer = setTimeout(() => {
                        if (isGazeValid) { 
                            playNote(parseFloat(key.dataset.f));
                        }
                    }, 100);
                }
            }
        }

        function playNote(freq) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'sawtooth'; // æ›´æœ‰åŠ›çš„è²éŸ³
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            // Lowpass filter
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1000;

            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.1);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
            
            osc.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1.5);
        }
    </script>
</body>
</html>
