<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™¤éŒ¯è¨ºæ–·ç‰ˆé›»å­ç´</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        
        #piano { display: flex; height: 100vh; width: 100vw; }
        
        .key { 
            flex: 1; border-right: 1px solid #000; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; box-sizing: border-box; background: #444; 
        }
        .key span { font-size: 1.5rem; color: rgba(255,255,255,0.5); pointer-events: none; margin-bottom: 5px; }
        .key-note { font-size: 2.5rem !important; color: #FFF !important; text-shadow: 0 0 5px black; }

        /* å½©è™¹é…è‰² */
        .key:nth-child(1) { background: #FF0000; }
        .key:nth-child(2) { background: #FF8800; }
        .key:nth-child(3) { background: #FFFF00; }
        .key:nth-child(4) { background: #00FF00; }
        .key:nth-child(5) { background: #0088FF; }
        .key:nth-child(6) { background: #0000FF; }
        .key:nth-child(7) { background: #8800FF; }
        .key:nth-child(8) { background: #FF00FF; }

        .key.active { filter: brightness(1.8); transform: scaleY(0.98); }

        /* æ¸¸æ¨™ */
        #cursor {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: #00FF00; border: 4px solid #fff; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 50;
            box-shadow: 0 0 20px #00FF00;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; color: black; font-weight: bold;
        }

        /* è¨ºæ–·è¦–çª— (åŠ å¤§ä¸€é»æ–¹ä¾¿çœ‹) */
        #debug-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 200px; height: 150px; 
            border: 3px solid #fff; z-index: 90; background: #000;
        }
        #cam-preview {
            width: 100%; height: 100%; 
            transform: scaleX(-1); /* é¡åƒ */
            object-fit: cover;
        }
        /* ç•«åœ¨è‡‰ä¸Šçš„ç´…é» Canvas */
        #face-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            transform: scaleX(-1); /* ä¹Ÿè¦é¡åƒ */
            pointer-events: none;
        }

        /* æ§åˆ¶é¢æ¿ */
        #panel {
            position: absolute; bottom: 20px; left: 20px; 
            background: rgba(0,0,0,0.9); color: white; padding: 15px;
            border-radius: 10px; z-index: 100; width: 220px;
        }
        button { padding: 12px; width: 100%; font-size: 1.1rem; background: #FFD700; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-weight: bold;}
        
        #status-text { color: yellow; font-size: 14px; margin-bottom: 10px; text-align: center;}
        
        label { display: block; font-size: 0.9rem; margin-top: 5px;}
        input[type=range] { width: 100%; }
    </style>
</head>
<body>

    <div id="panel">
        <div id="status-text">è«‹é»æ“Šå•Ÿå‹•</div>
        <button id="startBtn" onclick="init()">ğŸš€ å•Ÿå‹•ç›¸æ©Ÿ</button>
        <button onclick="location.reload()" style="background:#FF4444; color:white;">ğŸ”„ é‡æ–°æ•´ç†</button>
        
        <label>éˆæ•åº¦ (Sensitivity): <span id="val-sens">4.0</span></label>
        <input type="range" id="sensitivity" min="1" max="8" step="0.5" value="4.0">
    </div>

    <div id="debug-container">
        <video id="cam-preview" autoplay playsinline muted></video>
        <canvas id="face-canvas"></canvas>
    </div>

    <div id="cursor"></div>

    <div id="piano">
        <div class="key" data-f="261.63"><span class="key-note">Do</span><span>C4</span></div>
        <div class="key" data-f="293.66"><span class="key-note">Re</span><span>D4</span></div>
        <div class="key" data-f="329.63"><span class="key-note">Mi</span><span>E4</span></div>
        <div class="key" data-f="349.23"><span class="key-note">Fa</span><span>F4</span></div>
        <div class="key" data-f="392.00"><span class="key-note">Sol</span><span>G4</span></div>
        <div class="key" data-f="440.00"><span class="key-note">La</span><span>A4</span></div>
        <div class="key" data-f="493.88"><span class="key-note">Si</span><span>B4</span></div>
        <div class="key" data-f="523.25"><span class="key-note">Do</span><span>C5</span></div>
    </div>

    <video id="hidden-video" autoplay playsinline muted style="opacity:0; position:absolute; top:0; width:1px; height:1px;"></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script>
        const video = document.getElementById('hidden-video');
        const preview = document.getElementById('cam-preview');
        const faceCanvas = document.getElementById('face-canvas');
        const faceCtx = faceCanvas.getContext('2d');
        const cursor = document.getElementById('cursor');
        const statusText = document.getElementById('status-text');
        const startBtn = document.getElementById('startBtn');
        let audioCtx;

        let sensitivity = 4.0; // é è¨­å¾ˆé«˜ï¼Œè®“å®ƒå®¹æ˜“å‹•
        let currentX = window.innerWidth / 2;
        let targetX = window.innerWidth / 2;
        
        // ç‚ºäº†é¿å…å¡ä½ï¼Œæˆ‘å€‘ä¸ä½¿ç”¨è¤‡é›œçš„çœ¼å‹•æˆ–è½‰é ­éæ¿¾ï¼Œå›æ­¸æœ€åŸå§‹çš„ã€Œé¼»å°–ä½ç½®ã€
        // åªè¦æœ‰è‡‰ï¼Œå°±æœƒå‹•

        document.getElementById('sensitivity').oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            document.getElementById('val-sens').innerText = sensitivity;
        };

        async function init() {
            startBtn.disabled = true;
            statusText.innerText = "è¼‰å…¥æ¨¡å‹ä¸­...";
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // æ’­æ”¾éœéŸ³è§£é– iOS
            const b = audioCtx.createBuffer(1, 1, 22050);
            const s = audioCtx.createBufferSource(); s.buffer = b; s.connect(audioCtx.destination); s.start(0);

            try {
                // ä½¿ç”¨æ¨™æº–è§£æåº¦ 640x480ï¼Œé¿å… 320x240 åœ¨æŸäº›è¨­å‚™å°æ‡‰éŒ¯èª¤
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: "user" } 
                });
                video.srcObject = stream;
                preview.srcObject = stream;

                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onResults);

                video.onloadeddata = () => {
                    // è¨­å®š Canvas å¤§å°èˆ‡ Video ä¸€è‡´
                    faceCanvas.width = video.videoWidth;
                    faceCanvas.height = video.videoHeight;

                    const loop = async () => { 
                        if(!video.paused && !video.ended) {
                            await faceMesh.send({image: video}); 
                            requestAnimationFrame(loop); 
                        }
                    };
                    loop();
                    statusText.innerText = "ğŸŸ¢ ç³»çµ±é‹ä½œä¸­";
                    statusText.style.color = "#00FF00";
                    startBtn.style.display = 'none';
                };
            } catch (e) { 
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e); 
                statusText.innerText = "âŒ å¤±æ•—: " + e;
                startBtn.disabled = false;
            }
        }

        function onResults(results) {
            // æ¸…é™¤ç•«å¸ƒ
            faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const mesh = results.multiFaceLandmarks[0];
                const nose = mesh[1]; 

                // --- è¨ºæ–·åŠŸèƒ½ï¼šåœ¨è‡‰ä¸Šç•«ç´…é» ---
                // é€™æ˜¯ç‚ºäº†è®“è€å¸«çŸ¥é“ã€Œé›»è…¦æœ‰æ²’æœ‰çœ‹åˆ°é¼»å­ã€
                // å¦‚æœæ‚¨åœ¨å³ä¸‹è§’çœ‹åˆ°ç´…é»ï¼Œä½†æ¸¸æ¨™ä¸å‹•ï¼Œé‚£æ˜¯éˆæ•åº¦å•é¡Œ
                // å¦‚æœæ‚¨æ²’çœ‹åˆ°ç´…é»ï¼Œé‚£æ˜¯å…‰ç·šå•é¡Œ
                const x = nose.x * faceCanvas.width;
                const y = nose.y * faceCanvas.height;
                
                faceCtx.beginPath();
                faceCtx.arc(x, y, 10, 0, 2 * Math.PI); // ç•«ä¸€å€‹åŠå¾‘10çš„åœ“
                faceCtx.fillStyle = "red";
                faceCtx.fill();
                
                // --- è¨ˆç®—æ¸¸æ¨™ä½ç½® ---
                // é‚è¼¯ï¼š(1 - nose.x) æ˜¯å› ç‚ºé¡åƒ
                // ä¸­å¿ƒé»ä¿®æ­£ï¼š(åŸå§‹å€¼ - 0.5) * éˆæ•åº¦ + 0.5
                let rawX = 1 - nose.x; 
                let adjustedX = (rawX - 0.5) * sensitivity + 0.5;

                // è½‰æ›æˆè¢å¹•åƒç´ 
                targetX = adjustedX * window.innerWidth;

                // é™åˆ¶ä¸è¦è·‘å‡ºè¢å¹•å¤–
                if (targetX < 0) targetX = 0;
                if (targetX > window.innerWidth) targetX = window.innerWidth;
                
                cursor.style.borderColor = "white"; // æ­£å¸¸é¡è‰²
                cursor.innerText = "";
            } else {
                // æ²’æŠ“åˆ°è‡‰
                statusText.innerText = "âš ï¸ æ²’çœ‹åˆ°è‡‰";
                statusText.style.color = "yellow";
                cursor.style.borderColor = "red"; // è­¦å‘Šè‰²
                cursor.innerText = "?";
            }

            // å¹³æ»‘ç§»å‹•
            currentX = currentX * 0.9 + targetX * 0.1;
            cursor.style.left = currentX + 'px';

            checkCollision(currentX);
        }

        let lastKey = null;
        let playTimer = null;

        function checkCollision(x) {
            const element = document.elementFromPoint(x, window.innerHeight / 2);
            const key = element ? element.closest('.key') : null;

            if (key !== lastKey) {
                if (lastKey) lastKey.classList.remove('active');
                if (playTimer) clearTimeout(playTimer);

                lastKey = key;

                if (key) {
                    key.classList.add('active');
                    playTimer = setTimeout(() => {
                        playNote(parseFloat(key.dataset.f));
                    }, 50);
                }
            }
        }

        function playNote(freq) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass"; filter.frequency.value = 1500;

            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.0);
            
            osc.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1.0);
        }
    </script>
</body>
</html>
