<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼動儀鋼琴 (WebGazer版)</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: Arial, sans-serif; display: flex; flex-direction: column; }
        
        #piano-container { display: flex; height: 100vh; width: 100vw; }
        .key { flex: 1; border-right: 2px solid #000; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 30px; box-sizing: border-box; }
        .key span { font-size: 2rem; font-weight: bold; pointer-events: none; }
        .key.active { filter: brightness(1.5); box-shadow: inset 0 0 50px white; }

        /* 為了讓校準更容易，我們做一個覆蓋層 */
        #calibration-overlay {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="calibration-overlay">
        <h3>校準說明：</h3>
        <p>1. 請允許開啟攝影機。</p>
        <p>2. 請在螢幕上不同位置(左/中/右)點擊滑鼠，同時眼睛盯著游標。</p>
        <p>3. 點擊越多次，紅色預測點會越準確。</p>
        <button onclick="webgazer.clearData()">清除校準重來</button>
    </div>

    <div id="piano-container">
        <div class="key" style="background-color: #FF4D4D;" data-freq="261.63"><span>Do</span></div>
        <div class="key" style="background-color: #FFFA65;" data-freq="329.63"><span>Mi</span></div>
        <div class="key" style="background-color: #32FF7E;" data-freq="392.00"><span>Sol</span></div>
        <div class="key" style="background-color: #18DCFF;" data-freq="523.25"><span>Do'</span></div>
        <div class="key" style="background-color: #C56CF0;" data-freq="659.25"><span>Mi'</span></div>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();
        let currentKey = null;
        let playTimer = null;

        function playTone(freq) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.0);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 1.0);
        }

        // WebGazer 設定
        window.onload = async function() {
            await webgazer.setRegression('ridge') 
                .setGazeListener(function(data, clock) {
                    if (data == null) return;
                    
                    // data.x 和 data.y 是預測的眼球注視座標
                    const x = data.x;
                    const y = data.y;

                    // 判斷落在哪個琴鍵
                    const element = document.elementFromPoint(x, window.innerHeight / 2); // 只看 X 軸，Y 軸鎖定在中間
                    const key = element ? element.closest('.key') : null;

                    if (key && key !== currentKey) {
                        if (currentKey) currentKey.classList.remove('active');
                        currentKey = key;
                        currentKey.classList.add('active');
                        
                        // 觸發聲音 (加一點延遲避免亂飄)
                        if(playTimer) clearTimeout(playTimer);
                        playTimer = setTimeout(() => {
                            const freq = currentKey.getAttribute('data-freq');
                            playTone(parseFloat(freq));
                        }, 200); // 停留200毫秒才響
                    }
                })
                .begin();

            // 開啟預覽點 (紅點)
            webgazer.showPredictionPoints(true); 
        };
    </script>
</body>
</html>
