<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾æº–çœ¼æ§ç´ (é˜²åˆ†å¿ƒç‰ˆ)</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        
        #piano { display: flex; height: 100vh; width: 100vw; }
        
        .key { 
            flex: 1; border-right: 1px solid #000; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; box-sizing: border-box; background: #444; 
        }
        
        /* ç´éµæ–‡å­— */
        .key span { font-size: 1.2rem; font-weight: bold; color: rgba(0,0,0,0.5); pointer-events: none; margin-bottom: 5px; }
        .key-note { font-size: 1.8rem !important; color: #000 !important; }

        /* ç´éµé¡è‰² */
        .key:nth-child(odd) { background: #e0e0e0; }
        .key:nth-child(even) { background: #f5f5f5; }
        /* ç‚ºäº†é«˜å°æ¯”ï¼Œæˆ‘å€‘é‚„æ˜¯ç”¨å½©è™¹è‰²ï¼Œä½†åŠ å¼·ä¸€é» */
        .key:nth-child(1) { background: #FF9999; } 
        .key:nth-child(2) { background: #FFCC99; }
        .key:nth-child(3) { background: #FFFF99; }
        .key:nth-child(4) { background: #99FF99; }
        .key:nth-child(5) { background: #99CCFF; }
        .key:nth-child(6) { background: #CC99FF; }
        .key:nth-child(7) { background: #FF99FF; }
        .key:nth-child(8) { background: #FF4D4D; }

        .key.active { 
            filter: brightness(1.2); transform: scaleY(0.98); 
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.2);
        }

        /* æ¸¸æ¨™ */
        #cursor {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            background: rgba(0, 255, 0, 0.8); /* ç¶ è‰²ä»£è¡¨OK */
            border: 3px solid #fff; border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 50; box-shadow: 0 0 15px #00FF00;
            transition: left 0.1s ease-out, top 0.1s ease-out, background 0.2s;
            display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold; font-size: 20px;
        }
        /* ç•¶ä¸å°ˆæ³¨æ™‚çš„æ¸¸æ¨™æ¨£å¼ */
        #cursor.inactive {
            background: rgba(100, 100, 100, 0.5) !important;
            border-color: #555;
            box-shadow: none;
        }
        #cursor.playing { background: #FF0000; width: 50px; height: 50px; }

        /* é¢æ¿ */
        #panel {
            position: absolute; bottom: 20px; left: 20px; 
            background: rgba(0,0,0,0.9); color: white; padding: 15px;
            border-radius: 10px; z-index: 100; width: 300px;
        }
        button {
            padding: 10px; width: 100%; font-size: 1.1rem; 
            background: #FFD700; border: none; border-radius: 5px; cursor: pointer;
            margin-bottom: 10px;
        }
        label { display: block; margin: 8px 0 2px; font-size: 0.9rem;}
        input[type=range] { width: 100%; }
        
        #cam-preview {
            position: absolute; bottom: 20px; right: 20px;
            width: 160px; height: 120px; background: #000; 
            border: 3px solid #333; transform: scaleX(-1); opacity: 0.9; z-index: 100;
        }
        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ (åœ¨é è¦½è¦–çª—ä¸Š) */
        #face-status {
            position: absolute; bottom: 125px; right: 20px;
            color: white; background: red; padding: 2px 8px; font-size: 12px; z-index: 101;
        }
    </style>
</head>
<body>

    <div id="panel">
        <button id="startBtn" onclick="init()">å•Ÿå‹•ç›¸æ©Ÿ</button>
        <div id="msg" style="color:yellow;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹</div>
        <hr style="border-color:#555">
        
        <label>ğŸ¹ éˆæ•åº¦ (Sensitivity): <span id="val-sens">2.5</span></label>
        <input type="range" id="sensitivity" min="1" max="5" step="0.1" value="2.5">
        
        <label>ğŸ§ åš´æ ¼åº¦ (å®¹è¨±è½‰é ­çš„ç¨‹åº¦): <span id="val-strict">0.6</span></label>
        <input type="range" id="strictness" min="0.1" max="1.5" step="0.1" value="0.6">
        <div style="font-size: 0.8rem; color: #aaa;">æ•¸å€¼è¶Šå°ï¼Œé ­å¿…é ˆè¶Šæ­£æ‰æœƒæœ‰è²éŸ³ã€‚</div>
    </div>

    <div id="face-status">æœªåµæ¸¬</div>
    <video id="cam-preview" autoplay playsinline muted></video>
    <video id="hidden-video" autoplay playsinline muted style="opacity:0; position:absolute; top:0; pointer-events:none;"></video>

    <div id="cursor"></div>

    <div id="piano">
        <div class="key" data-f="261.63"><span class="key-note">Do</span><span>C4</span></div>
        <div class="key" data-f="293.66"><span class="key-note">Re</span><span>D4</span></div>
        <div class="key" data-f="329.63"><span class="key-note">Mi</span><span>E4</span></div>
        <div class="key" data-f="349.23"><span class="key-note">Fa</span><span>F4</span></div>
        <div class="key" data-f="392.00"><span class="key-note">Sol</span><span>G4</span></div>
        <div class="key" data-f="440.00"><span class="key-note">La</span><span>A4</span></div>
        <div class="key" data-f="493.88"><span class="key-note">Si</span><span>B4</span></div>
        <div class="key" data-f="523.25"><span class="key-note">Do</span><span>C5</span></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script>
        const video = document.getElementById('hidden-video');
        const preview = document.getElementById('cam-preview');
        const cursor = document.getElementById('cursor');
        const statusLabel = document.getElementById('face-status');
        let audioCtx;

        let sensitivity = 2.5;
        let strictness = 0.6; // åš´æ ¼åº¦é–¾å€¼
        let smoothing = 0.85;

        let currentX = window.innerWidth / 2;
        let targetX = window.innerWidth / 2;
        let isFaceValid = false; // æ˜¯å¦ã€Œæ­£è¦–ã€è¢å¹•

        // UI ç¶å®š
        document.getElementById('sensitivity').oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            document.getElementById('val-sens').innerText = sensitivity;
        };
        document.getElementById('strictness').oninput = (e) => {
            strictness = parseFloat(e.target.value);
            document.getElementById('val-strict').innerText = strictness;
        };

        async function init() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('msg').innerText = "è¼‰å…¥æ¨¡å‹ä¸­...";
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // è§£é–éŸ³æ•ˆ
            const b = audioCtx.createBuffer(1, 1, 22050);
            const s = audioCtx.createBufferSource(); s.buffer = b; s.connect(audioCtx.destination); s.start(0);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width:640, height:480 } });
                video.srcObject = stream;
                preview.srcObject = stream;

                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({ maxNumFaces: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                faceMesh.onResults(onResults);

                video.onloadeddata = () => {
                    const loop = async () => { await faceMesh.send({image: video}); requestAnimationFrame(loop); };
                    loop();
                    document.getElementById('msg').innerText = "âœ… é‹ä½œä¸­ - è«‹ä¿æŒæ­£è¦–è¢å¹•";
                    document.getElementById('startBtn').style.display = 'none';
                };
            } catch (e) { alert("ç›¸æ©ŸéŒ¯èª¤: " + e); }
        }

        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const mesh = results.multiFaceLandmarks[0];
                
                // 1. å–å¾—é—œéµé»
                const nose = mesh[1]; // é¼»å°–
                const leftEyeOuter = mesh[33];  // å·¦çœ¼è§’
                const rightEyeOuter = mesh[263]; // å³çœ¼è§’
                
                // 2. è¨ˆç®—è‡‰éƒ¨è½‰å‘ (Yaw) - åˆ©ç”¨é¼»å­èˆ‡å…©çœ¼è§’çš„ç›¸å°è·é›¢
                // å¦‚æœé¼»å­æ­£ä¸­é–“ï¼ŒnoseToLeft æ‡‰è©²ç­‰æ–¼ noseToRight
                const noseToLeft = Math.abs(nose.x - leftEyeOuter.x);
                const noseToRight = Math.abs(nose.x - rightEyeOuter.x);
                const ratio = noseToLeft / (noseToRight + 0.0001); // é¿å…é™¤ä»¥0

                // 3. åˆ¤æ–·æ˜¯å¦ã€Œæ­£è¦–ã€
                // å®Œç¾æ­£è¦– ratio ç‚º 1ã€‚å¦‚æœè½‰é ­ï¼Œratio æœƒè®Šæˆ 0.2 æˆ– 5.0
                // strictness æ§åˆ¶é€™å€‹å®¹è¨±ç¯„åœ (ä¾‹å¦‚ 0.5 ~ 2.0)
                // å¦å¤–åŠ ä¸€å€‹ Pitch åˆ¤æ–· (é¼»å­ä¸èƒ½æ¯”çœ¼ç›é«˜å¤ªå¤šï¼Œé¿å…ä»°é ­)
                
                // ç°¡åŒ–åˆ¤æ–·ï¼šå·®å€¼æ¯”ä¾‹
                const diff = Math.abs(noseToLeft - noseToRight);
                const width = noseToLeft + noseToRight;
                const turnFactor = diff / width; // 0 = æ­£ä¸­, 1 = æ¥µåº¦å´é¢

                if (turnFactor < strictness) {
                    // --- åˆæ ¼ï¼šè‡‰æ˜¯æ­£çš„ ---
                    isFaceValid = true;
                    statusLabel.innerText = "ğŸŸ¢ é–å®šä¸­";
                    statusLabel.style.background = "green";
                    cursor.classList.remove('inactive');
                    cursor.innerText = "";
                } else {
                    // --- ä¸åˆæ ¼ï¼šè‡‰è½‰é–‹äº† ---
                    isFaceValid = false;
                    statusLabel.innerText = "ğŸ”´ è«‹çœ‹è¢å¹•";
                    statusLabel.style.background = "red";
                    cursor.classList.add('inactive');
                    cursor.innerText = "âŒ";
                }

                // 4. è¨ˆç®—æ¸¸æ¨™ä½ç½® (å³ä½¿æ²’æ­£è¦–ä¹Ÿè¨ˆç®—ï¼Œä½†è¦–è¦ºä¸Šè®Šç°)
                let rawX = (1 - nose.x) * window.innerWidth;
                let centerX = window.innerWidth / 2;
                let adjustedX = centerX + (rawX - centerX) * sensitivity;
                
                if (adjustedX < 0) adjustedX = 0;
                if (adjustedX > window.innerWidth) adjustedX = window.innerWidth;

                targetX = adjustedX;

            } else {
                isFaceValid = false;
                statusLabel.innerText = "æœªåµæ¸¬åˆ°è‡‰";
            }

            // å¹³æ»‘ç§»å‹•
            currentX = currentX * smoothing + targetX * (1 - smoothing);
            cursor.style.left = currentX + 'px';

            // åªæœ‰åœ¨è‡‰éƒ¨æœ‰æ•ˆæ™‚ï¼Œæ‰è§¸ç™¼ç´éµ
            if (isFaceValid) {
                checkCollision(currentX);
            } else {
                // å¦‚æœè‡‰ä¸æ­£ï¼Œæ¸…é™¤æ‰€æœ‰æŒ‰éµç‹€æ…‹
                if (lastKey) lastKey.classList.remove('active');
                lastKey = null;
                cursor.classList.remove('playing');
            }
        }

        let lastKey = null;
        let playTimer = null;

        function checkCollision(x) {
            const element = document.elementFromPoint(x, window.innerHeight / 2);
            const key = element ? element.closest('.key') : null;

            if (key !== lastKey) {
                if (lastKey) lastKey.classList.remove('active');
                if (playTimer) clearTimeout(playTimer);
                cursor.classList.remove('playing');

                lastKey = key;

                if (key) {
                    key.classList.add('active');
                    // åœç•™ 100ms æ‰ç™¼è²ï¼Œé¿å…å¿«é€Ÿæƒé
                    playTimer = setTimeout(() => {
                        if (isFaceValid) { // å†æ¬¡ç¢ºèªè‡‰é‚„æ˜¯æ­£çš„
                            playNote(parseFloat(key.dataset.f));
                            cursor.classList.add('playing');
                        }
                    }, 100);
                }
            }
        }

        function playNote(freq) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            // ä½¿ç”¨ Triangle æ³¢ï¼Œæ¯”è¼ƒåƒé•·ç¬›/æŸ”å’Œç´è²
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);
            
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1.2);
        }
    </script>
</body>
</html>
