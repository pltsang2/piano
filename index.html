<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¼•é‡æµæš¢ç‰ˆé›»å­ç´</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        
        #piano { display: flex; height: 100vh; width: 100vw; }
        
        .key { 
            flex: 1; border-right: 1px solid #000; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 20px; box-sizing: border-box; background: #444; 
        }
        .key span { font-size: 1.5rem; color: rgba(255,255,255,0.5); pointer-events: none; margin-bottom: 5px; }
        .key-note { font-size: 2.5rem !important; color: #FFF !important; text-shadow: 0 0 5px black; }

        /* é«˜å°æ¯”é…è‰² */
        .key:nth-child(1) { background: #FF0000; }
        .key:nth-child(2) { background: #FF8800; }
        .key:nth-child(3) { background: #FFFF00; }
        .key:nth-child(4) { background: #00FF00; }
        .key:nth-child(5) { background: #0088FF; }
        .key:nth-child(6) { background: #0000FF; }
        .key:nth-child(7) { background: #8800FF; }
        .key:nth-child(8) { background: #FF00FF; }

        .key.active { filter: brightness(1.8); transform: scaleY(0.98); }

        /* æ¸¸æ¨™ */
        #cursor {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            background: #00FF00; border: 3px solid #fff; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 50;
            box-shadow: 0 0 15px #00FF00;
            transition: left 0.05s linear; /* åæ‡‰æ›´å¿« */
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: red; font-size: 24px;
        }
        
        /* ç•¶ä¸å°ˆæ³¨æ™‚ */
        #cursor.locked { 
            background: #555 !important; 
            box-shadow: none; 
            border-color: #999;
            width: 30px; height: 30px;
        }

        /* æ§åˆ¶é¢æ¿ */
        #panel {
            position: absolute; bottom: 20px; left: 20px; 
            background: rgba(0,0,0,0.8); color: white; padding: 15px;
            border-radius: 10px; z-index: 100; width: 250px;
        }
        button { padding: 10px; width: 100%; font-size: 1.1rem; background: #FFD700; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 5px;}
        .reset-btn { background: #FF4444; color: white; margin-top: 10px; }
        
        label { display: block; margin: 8px 0 2px; font-size: 0.9rem;}
        input[type=range] { width: 100%; }

        /* é è¦½è¦–çª— (ç¸®å°ä»¥çœæ•ˆèƒ½) */
        #cam-preview {
            position: absolute; bottom: 20px; right: 20px;
            width: 120px; height: 90px; background: #000; 
            border: 2px solid #fff; transform: scaleX(-1); opacity: 0.8; z-index: 90;
        }
        #status-light {
            position: absolute; bottom: 115px; right: 20px;
            font-size: 14px; font-weight: bold; color: #00FF00;
            background: rgba(0,0,0,0.5); padding: 2px 5px; z-index: 91;
        }
    </style>
</head>
<body>

    <div id="panel">
        <button id="startBtn" onclick="init()">ğŸš€ å•Ÿå‹• (è¼•é‡ç‰ˆ)</button>
        <button class="reset-btn" onclick="location.reload()">ğŸ”„ å¡ä½è«‹é»æˆ‘é‡ç½®</button>
        
        <hr style="border-color:#555">
        
        <label>ğŸ§ åš´æ ¼åº¦ (è¦çœ‹å¤šæ­£?): <span id="val-strict">0.6</span></label>
        <input type="range" id="strictness" min="0.1" max="1.0" step="0.1" value="0.6">
        
        <label>ğŸ¹ éˆæ•åº¦ (é ­è½‰å¤šå¿«?): <span id="val-sens">3.0</span></label>
        <input type="range" id="sensitivity" min="1" max="6" step="0.1" value="3.0">
    </div>

    <div id="status-light">å¾…æ©Ÿä¸­</div>
    <video id="cam-preview" autoplay playsinline muted></video>
    
    <div id="cursor" class="locked"></div>

    <div id="piano">
        <div class="key" data-f="261.63"><span class="key-note">Do</span><span>C4</span></div>
        <div class="key" data-f="293.66"><span class="key-note">Re</span><span>D4</span></div>
        <div class="key" data-f="329.63"><span class="key-note">Mi</span><span>E4</span></div>
        <div class="key" data-f="349.23"><span class="key-note">Fa</span><span>F4</span></div>
        <div class="key" data-f="392.00"><span class="key-note">Sol</span><span>G4</span></div>
        <div class="key" data-f="440.00"><span class="key-note">La</span><span>A4</span></div>
        <div class="key" data-f="493.88"><span class="key-note">Si</span><span>B4</span></div>
        <div class="key" data-f="523.25"><span class="key-note">Do</span><span>C5</span></div>
    </div>

    <video id="hidden-video" autoplay playsinline muted style="opacity:0; position:absolute; top:0; width:1px; height:1px;"></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script>
        const video = document.getElementById('hidden-video');
        const preview = document.getElementById('cam-preview');
        const cursor = document.getElementById('cursor');
        const statusLight = document.getElementById('status-light');
        let audioCtx;

        // åƒæ•¸é è¨­å€¼
        let sensitivity = 3.0; // ç¨å¾®èª¿é«˜éˆæ•åº¦ï¼Œè®“æ“ä½œæ›´è¼•é¬†
        let strictness = 0.6; 
        let currentX = window.innerWidth / 2;
        let targetX = window.innerWidth / 2;
        let isFocused = false;

        document.getElementById('sensitivity').oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            document.getElementById('val-sens').innerText = sensitivity;
        };
        document.getElementById('strictness').oninput = (e) => {
            strictness = parseFloat(e.target.value);
            document.getElementById('val-strict').innerText = strictness;
        };

        async function init() {
            document.getElementById('startBtn').disabled = true;
            statusLight.innerText = "è¼‰å…¥ä¸­...";
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const b = audioCtx.createBuffer(1, 1, 22050);
            const s = audioCtx.createBufferSource(); s.buffer = b; s.connect(audioCtx.destination); s.start(0);

            try {
                // âš ï¸ é—œéµå„ªåŒ–ï¼šå°‡è§£æåº¦é™åˆ° 320x240ï¼Œå¤§å¹…æ¸›å°‘å¡é “
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 320, height: 240, facingMode: "user" } 
                });
                video.srcObject = stream;
                preview.srcObject = stream;

                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: false, // âš ï¸ é—œé–‰è™¹è†œåµæ¸¬ï¼Œé€™æ˜¯ä¸€åˆ‡å¡é “çš„å…ƒå…‡
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onResults);

                video.onloadeddata = () => {
                    const loop = async () => { 
                        if (video.paused || video.ended) return;
                        await faceMesh.send({image: video}); 
                        requestAnimationFrame(loop); 
                    };
                    loop();
                    statusLight.innerText = "é‹ä½œä¸­";
                    document.getElementById('startBtn').style.display = 'none';
                };
            } catch (e) { 
                alert("éŒ¯èª¤ï¼š" + e); 
                document.getElementById('startBtn').disabled = false;
            }
        }

        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const mesh = results.multiFaceLandmarks[0];
                
                // 1. å–å¾—é—œéµé» (é¼»å°–, å·¦è‡‰ç·£, å³è‡‰ç·£)
                const nose = mesh[1]; 
                const leftFace = mesh[234];
                const rightFace = mesh[454];

                // 2. è¨ˆç®—è½‰å‘ (Yaw) - åˆ©ç”¨é¼»å­èˆ‡è‡‰é °çš„è·é›¢æ¯”
                const distL = Math.abs(nose.x - leftFace.x);
                const distR = Math.abs(nose.x - rightFace.x);
                
                // è¨ˆç®—åé›¢ä¸­å¿ƒçš„ç¨‹åº¦ (0 = æ­£ä¸­, æ•¸å€¼è¶Šå¤§è¶Šå)
                const balance = Math.abs(distL - distR);
                const faceWidth = distL + distR;
                const turnRatio = balance / faceWidth; 

                // 3. åˆ¤æ–·æ˜¯å¦å°ˆæ³¨ (åš´æ ¼åº¦éæ¿¾)
                // é€™è£¡çš„ strictness é‚è¼¯ï¼šå¦‚æœè½‰é ­å¤ªéåˆ†ï¼Œå°±é–ä½
                // ä½†æˆ‘å€‘ä¿ç•™ä¸€é»å½ˆæ€§ï¼Œè®“æ¸¸æ¨™ç§»å‹•æ™‚ä¸æœƒä¸€ç›´æ–·æ–·çºŒçºŒ
                
                // åš´æ ¼åº¦é–¾å€¼ï¼šstrictness è¶Šå°ï¼Œå®¹å¿åº¦è¶Šä½
                // æˆ‘å€‘åè½‰ä¸€ä¸‹é‚è¼¯è®“ UI æ¯”è¼ƒå¥½æ‡‚ï¼š 
                // UI 0.1 (åš´æ ¼) -> å®¹è¨± turnRatio < 0.1
                // UI 1.0 (å¯¬é¬†) -> å®¹è¨± turnRatio < 0.5
                
                const threshold = strictness * 0.5;

                // é€™è£¡åšä¸€å€‹ã€Œç·©è¡å€ã€ï¼Œå¦‚æœæ˜¯æ˜é¡¯çš„å¤§è½‰é ­æ‰é–ä½
                // ç‚ºäº†è®“é«”é©—å¥½ä¸€é»ï¼Œæˆ‘å€‘ä¸»è¦ç”¨é€™ä¾†éæ¿¾ã€Œçœ‹æ—é‚Šã€
                if (turnRatio < 0.2 + (strictness * 0.3)) { 
                    isFocused = true;
                    cursor.classList.remove('locked');
                    cursor.innerText = "";
                    statusLight.innerText = "ğŸŸ¢ é–å®šä¸­";
                    statusLight.style.color = "#00FF00";
                } else {
                    // å¦‚æœè½‰é ­è§’åº¦å¤ªå¤§ï¼ˆçœ‹æ—é‚Šï¼‰
                    isFocused = false;
                    cursor.classList.add('locked');
                    cursor.innerText = "âŒ";
                    statusLight.innerText = "ğŸ”´ è«‹çœ‹è¢å¹•";
                    statusLight.style.color = "red";
                }

                // 4. è¨ˆç®—æ¸¸æ¨™ä½ç½®
                // ä½¿ç”¨é¼»å°–åº§æ¨™æ§åˆ¶
                let rawX = (1 - nose.x) * window.innerWidth;
                let centerX = window.innerWidth / 2;
                let adjustedX = centerX + (rawX - centerX) * sensitivity;

                if (adjustedX < 0) adjustedX = 0;
                if (adjustedX > window.innerWidth) adjustedX = window.innerWidth;

                targetX = adjustedX;

            } else {
                statusLight.innerText = "æœªåµæ¸¬åˆ°äººè‡‰";
                isFocused = false;
            }

            // å¹³æ»‘ç§»å‹• (æ•¸å€¼è¶Šå°è¶Šé»ï¼Œè¶Šå¤§è¶Šå¿«)
            currentX = currentX * 0.8 + targetX * 0.2;
            cursor.style.left = currentX + 'px';

            if (isFocused) {
                checkCollision(currentX);
            } else {
                if (lastKey) lastKey.classList.remove('active');
                lastKey = null;
            }
        }

        let lastKey = null;
        let playTimer = null;

        function checkCollision(x) {
            const element = document.elementFromPoint(x, window.innerHeight / 2);
            const key = element ? element.closest('.key') : null;

            if (key !== lastKey) {
                if (lastKey) lastKey.classList.remove('active');
                if (playTimer) clearTimeout(playTimer);

                lastKey = key;

                if (key) {
                    key.classList.add('active');
                    // åœç•™ 50ms å°±ç™¼è² (åæ‡‰èª¿å¿«ä¸€é»)
                    playTimer = setTimeout(() => {
                        if (isFocused) { 
                            playNote(parseFloat(key.dataset.f));
                        }
                    }, 50);
                }
            }
        }

        function playNote(freq) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            
            // ä½¿ç”¨é‹¸é½’æ³¢ (Sawtooth) è²éŸ³æ¯”è¼ƒæ˜é¡¯
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            // æ¿¾æ³¢å™¨è®“è²éŸ³ä¸åˆºè€³
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.value = 1000;

            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.0);
            
            osc.connect(filter);
            filter.connect(g);
            g.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 1.0);
        }
    </script>
</body>
</html>
